datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                    Int              @id @default(autoincrement())
  email                 String           @unique
  firstName             String?
  lastName              String?
  phone                 String
  password              String
  post                  String           @default("Employee")
  role                  Role[]
  members               Member[]
  benefits              RequestModel[]   @relation(name: "userbeneficiary")
  requests              RequestModel[]
  spending              Spending[]
  project               Project[]        @relation("ProjectChief")
  status                String           @default("active")
  lastConnection        DateTime?
  verificationOtp       String?
  verified              Boolean          @default(false)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  commandRequests       CommandRequest[]
  devis                 Devi[]
  validators            Validator[]
  payments              Payment[]
  receptions            Reception[]
  notifications         Notification[]
  projects              Project[]        @relation("ProjectOwner")
  beneficiat            Payment[]        @relation("paymentBenef")
  transactions          Transaction[]    @relation(name: "creator")
  validatedTransactions Transaction[]    @relation(name: "validator")
}

model Role {
  id           Int            @id @default(autoincrement())
  label        String
  users        User[]
  pages        RolePages[]
  notification Notification[]
}

model RolePages {
  id         Int    @id @default(autoincrement())
  authorized Role[]
  pageId     String
}

model Department {
  id          Int      @id @default(autoincrement())
  reference   String   @default("none")
  label       String
  description String?
  members     Member[]
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Member {
  id             Int        @id @default(autoincrement())
  label          String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId   Int
  validator      Boolean    @default(false)
  position       Int        @default(0)
  chief          Boolean    @default(false)
  finalValidator Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Project {
  id          Int            @id @default(autoincrement())
  label       String
  reference   String         @default("none")
  status      String         @default("ongoing")
  description String?        @default("Aucun description")
  chief       User?          @relation("ProjectChief", fields: [chiefId], references: [id], onDelete: SetNull)
  chiefId     Int?
  budget      Float          @default(0)
  requests    RequestModel[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  payments    Payment[]
  user        User           @relation("ProjectOwner", fields: [userId], references: [id])
  userId      Int            @default(1)
}

model RequestValidation {
  id          Int          @id @default(autoincrement())
  decision    String
  validator   Validator    @relation(references: [id], fields: [validatorId], onDelete: Cascade)
  validatorId Int
  request     RequestModel @relation(references: [id], fields: [requestId], onDelete: Cascade)
  requestId   Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
}

model RequestModel {
  id               Int                 @id @default(autoincrement())
  ref              String
  label            String
  description      String?
  quantity         Int
  dueDate          DateTime
  period           Json?
  benFac           Json?
  unit             String
  beneficiary      String
  amount           Int?
  type             String              @default("PURCHASE")
  beficiaryList    User[]              @relation(name: "userbeneficiary")
  revieweeList     RequestValidation[]
  state            String              @default("pending")
  priority         String              @default("normal")
  category         Category            @relation(name: "RequestCategory", references: [id], fields: [categoryId], onDelete: Cascade)
  categoryId       Int
  user             User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId           Int?
  project          Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId        Int?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  commandRequest   CommandRequest?     @relation(fields: [commandRequestId], references: [id], onDelete: SetNull)
  commandRequestId Int?
  command          Command?            @relation(fields: [commandId], references: [id])
  commandId        Int?
  deviElements     DeviElement[]
  payments         Payment[]
}

model Category {
  id          Int            @id @default(autoincrement())
  label       String
  description String?
  requests    RequestModel[] @relation(name: "RequestCategory")
  validators  Validator[]
}

model Validator {
  id               Int                 @id @default(autoincrement())
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  ctegory          Category            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  RequestValidated RequestValidation[]
  rank             Int
  userId           Int
  categoryId       Int
}

model CommandRequest {
  id           Int            @id @default(autoincrement())
  title        String
  besoins      RequestModel[]
  dueDate      DateTime
  reference    String         @unique
  deliveryDate DateTime       @default(now())
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents    Document[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  name         String?
  phone        String?
  userId       Int
  devi         Devi[]
  provider     Provider?      @relation(fields: [providerId], references: [id])
  providerId   Int?
}

model RequestTypes {
  id          Int    @id @default(autoincrement())
  label       String
  description String
}

model Devi {
  id               Int             @id @default(autoincrement())
  provider         Provider        @relation(fields: [providerId], references: [id])
  providerId       Int
  proof            String
  ref              String          @default("none")
  user             User            @relation(fields: [userId], references: [id])
  userId           Int
  status           String          @default("PENDING")
  commandRequestId Int?
  commandRequest   CommandRequest? @relation(fields: [commandRequestId], references: [id], onDelete: Cascade)
  element          DeviElement[]
  dueDate          DateTime?
  // one to one relation with Command
  command          Command?        @relation(fields: [commandId], references: [id], onDelete: SetNull)
  commandId        Int?            @unique()
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([providerId, commandRequestId])
}

model DeviElement {
  id             Int           @id @default(autoincrement())
  request        RequestModel? @relation(fields: [requestModelId], references: [id], onDelete: SetNull)
  requestModelId Int?
  quantity       Int
  unit           String
  title          String
  status         String        @default("NOT_SELECTED")
  isDelivered    Boolean       @default(false)
  priceProposed  Int
  devi           Devi          @relation(fields: [deviId], references: [id], onDelete: Cascade)
  deviId         Int
  reception      Reception?    @relation(fields: [receptionId], references: [id])
  receptionId    Int?
}

model Command {
  id               Int            @id @default(autoincrement())
  provider         Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  deliveryDelay    DateTime
  paymentTerms     String
  paymentMethod    String
  priority         String
  deliveryLocation String
  hasPenalties     Boolean
  penaltyMode      String
  amountBase       Int
  motif            String?
  requests         RequestModel[]
  providerId       Int
  instalments      Instalments[]
  payments         Payment[]
  reference        String         @default("none")
  // one to one relation with Devi
  devi             Devi?
  deviId           Int?           @unique()
  status           String?        @default("PENDING")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  réceptions      Reception[]
}

model Instalments {
  id         Int      @id @default(autoincrement())
  percentage Float
  command    Command? @relation(fields: [commandId], references: [id])
  deadLine   DateTime @default(now())
  commandId  Int?
  status     Boolean  @default(false)
}

model Document {
  id        Int             @id @default(autoincrement())
  path      String          @unique
  size      String
  cmdRqst   CommandRequest? @relation(fields: [cmdRqstId], references: [id], onDelete: SetNull)
  cmdRqstId Int?
}

model Provider {
  id Int @id @default(autoincrement())

  name    String
  phone   String?
  email   String?
  address String?

  RCCM  String?
  NIU   String?
  regem String?

  status             Boolean          @default(false)
  commandRequest     CommandRequest[]
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  devis              Devi[]
  commands           Command[]
  carte_contribuable String?
  acf                String?
  plan_localisation  String?
  commerce_registre  String?
  banck_attestation  String?
  réceptions        Reception[]
}

// working on
model Payment {
  id        Int    @id @default(autoincrement())
  reference String
  status    String
  type      String // RH, FAC, BC
  title     String

  description String @default("none")
  beneficiary User?  @relation(name: "paymentBenef", fields: [benefId], references: [id], onDelete: SetNull)
  benefId     Int?

  model  Vehicle? @relation(fields: [vehiclesId], references: [id])
  km     String?
  liters String?

  proof String?

  account       String?
  justification String?

  priority  String        @default("medium")
  price     Int
  isPartial Boolean       @default(false)
  user      User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId    Int?
  command   Command?      @relation(fields: [commandId], references: [id], onDelete: Cascade)
  commandId Int?
  project   Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  request   RequestModel? @relation(fields: [requestId], references: [id], onDelete: SetNull)
  requestId Int?
  projectId Int?
  method    String?
  deadline  DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt
  bank      Bank?         @relation(fields: [bankId], references: [id])

  vehiclesId Int?
  bankId     Int?
}

model Accounting {
  id        Int      @id @default(autoincrement())
  name      String
  banque    String
  type      String
  balance   Float
  currency  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Spending {
  id            Int      @id @default(autoincrement())
  totalSpending Float
  details       String
  date          DateTime
  state         String
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Signature {
  id        Int      @id @default(autoincrement())
  name      String
  path      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reception {
  id           Int           @id @default(autoincrement())
  Reference    String
  Command      Command?      @relation(fields: [CommandId], references: [id], onDelete: Cascade)
  Provider     Provider      @relation(fields: [ProviderId], references: [id], onDelete: Cascade)
  ProviderId   Int
  Status       String
  CommandId    Int?
  Deadline     DateTime
  ReceiptDate  DateTime?
  Proof        String?
  Deliverables DeviElement[]
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int?
  group     Boolean  @default(false)
  roles     Role[]
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bank {
  id            Int     @id @default(autoincrement())
  label         String
  type          String?
  balance       Float?
  // File
  justification String?
  // bank
  accountNumber String?
  bankCode      String?
  atmCode       String?
  key           String?
  // Mobile money
  phoneNum      String?
  merchantNum   String?

  Status Boolean @default(false)

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  incomming Transaction[] @relation(name: "incoming")
  outgoing  Transaction[] @relation(name: "outgoing")
  payments  Payment[]
}

model Transaction {
  id          Int       @id @default(autoincrement())
  label       String
  amount      Float
  date        DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  Type        String
  from        Bank      @relation(name: "incoming", fields: [fromBankId], references: [id])
  to          Bank      @relation(name: "outgoing", fields: [toBankId], references: [id])
  fromBankId  Int
  toBankId    Int
  proof       String?
  status      String? // APPROVED, PENDING, REJECTED
  reason      String?
  user        User?     @relation(name: "creator", fields: [userId], references: [id], onDelete: SetNull)
  userId      Int?
  validator   User?     @relation(name: "validator", fields: [validatorId], references: [id])
  validatorId Int?
}

model RequestType {
  id          Int     @id @default(autoincrement())
  label       String
  description String?
  type        String
}

model Vehicle {
  id        Int       @id @default(autoincrement())
  label     String
  mark      String
  matricule String    @unique
  payments  Payment[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
}
