datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              Int                 @id @default(autoincrement())
  email           String              @unique
  name            String
  phone           String
  password        String
  role            Role[]
  members         Member[]
  benefits        RequestModel[]      @relation(name: "userbeneficiary")
  requests        RequestModel[]
  requestReveiwed RequestValidation[]
  spending        Spending[]
  project         Project?            @relation("ProjectChief")
  status          String              @default("active")
  lastConnection  DateTime?
  projectId       Int?                @unique
  verificationOtp String?
  verified        Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  commandRequests CommandRequest[]
  devis           Devi[]
}

model Role {
  id    Int         @id @default(autoincrement())
  label String
  users User[]
  pages RolePages[]
}

model RolePages {
  id         Int    @id @default(autoincrement())
  authorized Role[]
  pageId     String
}

model Department {
  id          Int      @id @default(autoincrement())
  reference   String   @default("none")
  label       String
  description String?
  members     Member[]
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Member {
  id             Int        @id @default(autoincrement())
  label          String
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId   Int
  validator      Boolean    @default(false)
  position       Int        @default(0)
  chief          Boolean    @default(false)
  finalValidator Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Project {
  id          Int            @id @default(autoincrement())
  label       String
  reference   String         @default("none")
  status      String         @default("ongoing")
  description String?        @default("Aucun description")
  chief       User?          @relation("ProjectChief", fields: [chiefId], references: [id], onDelete: SetNull)
  chiefId     Int?           @unique
  budget      Float          @default(0)
  requests    RequestModel[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model RequestValidation {
  id          Int          @id @default(autoincrement())
  decision    String
  validator   User         @relation(references: [id], fields: [validatorId], onDelete: Cascade)
  validatorId Int
  request     RequestModel @relation(references: [id], fields: [requestId], onDelete: Cascade)
  requestId   Int
}

model RequestModel {
  id               Int                 @id @default(autoincrement())
  ref              String
  label            String
  description      String?
  quantity         Int
  dueDate          DateTime
  unit             String
  beneficiary      String
  beficiaryList    User[]              @relation(name: "userbeneficiary")
  revieweeList     RequestValidation[]
  state            String              @default("pending")
  proprity         String              @default("normal")
  category         Category            @relation(name: "RequestCategory", references: [id], fields: [categoryId])
  categoryId       Int
  user             User                @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId           Int
  project          Project?            @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId        Int?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  commandRequest   CommandRequest?     @relation(fields: [commandRequestId], references: [id], onDelete: SetNull)
  commandRequestId Int?
  command          Command?            @relation(fields: [commandId], references: [id])
  commandId        Int?
  deviElements     DeviElement[]
}

model Category {
  id        Int            @id @default(autoincrement())
  label     String
  parent    Category?      @relation(name: "CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  parentId  Int?
  children  Category[]     @relation(name: "CategoryToCategory")
  requests  RequestModel[] @relation(name: "RequestCategory")
  isSpecial Boolean
}

model CommandRequest {
  id           Int            @id @default(autoincrement())
  title        String
  besoins      RequestModel[]
  dueDate      DateTime
  reference    String         @unique
  deliveryDate DateTime       @default(now())
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents    Document[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  userId       Int
  devi         Devi[]
  provider     Provider?      @relation(fields: [providerId], references: [id])
  providerId   Int?
}

model Devi {
  id               Int             @id @default(autoincrement())
  provider         Provider        @relation(fields: [providerId], references: [id])
  providerId       Int
  proof            String
  ref              String          @default("none")
  user             User            @relation(fields: [userId], references: [id])
  userId           Int
  status           String          @default("PENDING")
  commandRequestId Int?
  commandRequest   CommandRequest? @relation(fields: [commandRequestId], references: [id], onDelete: Cascade)
  element          DeviElement[]
  dueDate          DateTime?
  // one to one relation with Command
  command          Command?        @relation(fields: [commandId], references: [id], onDelete: SetNull)
  commandId        Int?            @unique()
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
}

model DeviElement {
  id             Int           @id @default(autoincrement())
  request        RequestModel? @relation(fields: [requestModelId], references: [id], onDelete: SetNull)
  requestModelId Int?
  quantity       Int
  unit           String
  title          String
  status         String        @default("NOT_SELECTED")
  priceProposed  Int
  devi           Devi          @relation(fields: [deviId], references: [id], onDelete: Cascade)
  deviId         Int
}

model Command {
  id               Int            @id @default(autoincrement())
  provider         Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  deliveryDelay    DateTime
  paymentTerms     String
  paymentMethod    String
  priority         String
  deliveryLocation String
  hasPenalties     Boolean
  penaltyMode      String
  amountBase       Int
  requests         RequestModel[]
  providerId       Int
  payments         Payment[]
  // one to one relation with Devi
  devi             Devi?
  deviId           Int?           @unique()
}

model Document {
  id        Int             @id @default(autoincrement())
  path      String          @unique
  size      String
  cmdRqst   CommandRequest? @relation(fields: [cmdRqstId], references: [id], onDelete: SetNull)
  cmdRqstId Int?
}

model Provider {
  id                 Int              @id @default(autoincrement())
  name               String
  phone              String?
  email              String?
  address            String?
  taxId              String?
  rating             Int              @default(0)
  status             Boolean          @default(false)
  commandRequest     CommandRequest[]
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  devis              Devi[]
  commands           Command[]
  carte_contribuable String?
  acf                String?
  plan_localisation  String?
  commerce_registre  String?
  banck_attestation  String?
}

model Payment {
  id        Int      @id @default(autoincrement())
  reference String
  createdAt DateTime
  status    String
  price     Int
  userId    Int
  command   Command  @relation(fields: [commandId], references: [id], onDelete: Cascade)
  commandId Int
}

model Accounting {
  id        Int      @id @default(autoincrement())
  name      String
  banque    String
  type      String
  balance   Float
  currency  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Spending {
  id            Int      @id @default(autoincrement())
  totalSpending Float
  details       String
  date          DateTime
  state         String
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Signature {
  id        Int      @id @default(autoincrement())
  name      String
  path      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
